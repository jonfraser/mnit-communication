@using MNIT_Communication.Models
@model BaseModel
@{
    ViewBag.Title = "Current Outages";
}
<h1>Current Outages</h1>
<p class="lead">
    Listed below are all the currently known outages and latest update. Rest assured we are working hard to restore service and you'll be notified
    as soon as things are back to normal.
</p>
<form class="container-fluid" ng-controller="AlertsController">
    <h3>{{outageSummary}}</h3>
    <div class="row" ng-show="outages.length > 0">
        <div class="col-md-12">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Service</th>
                        <th>Outage Start</th>
                        <th>Description</th>
                        <th>Current Status</th>
                        <th>Last Updated</th>
                    </tr>
                </thead>
                <tbody>
                    <tr ng-repeat="outage in outages | orderBy:'Service'">
                        <td>{{outage.Service.Name}}</td>
                        <td>
                            <span am-time-ago="outage.Start" title="{{outage.Start | amDateFormat:'dddd, MMMM Do YYYY, h:mm:ss a'}}"></span>
                        </td>
                        <td>{{outage.Summary}}</td>
                        <td>{{outage.LastUpdate.Display}}</td>
                        <td>
                            <span am-time-ago="outage.UpdateDate" title="{{outage.UpdateDate | amDateFormat:'dddd, MMMM Do YYYY, h:mm:ss a'}}"></span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</form>

@section scripts {
    @System.Web.Optimization.Scripts.Render("~/Scripts/jquery.signalR-2.2.0.min.js")
    <script src="~/signalr/hubs"></script>
    
    @Scripts.Render("~/bundles/moment")
    
    <script type="text/javascript">

        angular.module('communicationApp', ['angularMoment'])
            .controller('AlertsController', ['$scope', '$http', function ($scope, $http) {

                $http.get('@Url.HttpRouteUrl("DefaultApi", new { action = "Get", controller = "Alerts"})').
                     success(function (data) {
                         $scope.outages = data || [];
                     }).
                     error(function () {
                         $scope.outages = [];
                     })
                     .finally(function () {
                         if ($scope.outages.length === 0) {
                             $scope.outageSummary = 'Awesome! There aren\'t any outages at the moment!';
                         } else {
                            $scope.outageSummary = $scope.outages.length + " current outages";
                         }
                     });

                var outageHub = $.connection.outageHub;
                outageHub.client.addOutageUpdateToPage = function (outageDetail, isNew, isUpdate, isRemove) {
                    if (isNew) {
                        $scope.outages.push(outageDetail);
                    }
                    if (isUpdate) {
                        //todo: find and update
                    }
                    if (isRemove) {
                        //todo: remove
                    }
                    $scope.$apply();
                };
                $.connection.hub.start();

            }]);

    </script>
}
